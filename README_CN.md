# OpenVPNAdvanced ä¸­æ–‡è¯´æ˜æ–‡æ¡£

> ä¸€ä¸ªåŸºäºè§„åˆ™çš„ OpenVPN æµé‡åˆ†æµå™¨ï¼Œæ”¯æŒ DoH DNS ä»£ç†ã€è§„åˆ™è®¢é˜…ã€åŠ¨æ€æ·»åŠ è·¯ç”±ã€ç¼“å­˜åŠ é€Ÿç­‰ã€‚

---

## ğŸ“š ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [ä½¿ç”¨æ•™ç¨‹](#ä½¿ç”¨æ•™ç¨‹)
  - [å‰ç½®ä¾èµ–](#å‰ç½®ä¾èµ–)
  - [å®‰è£…æ„å»º](#å®‰è£…æ„å»º)
  - [å¯åŠ¨æœåŠ¡](#å¯åŠ¨æœåŠ¡)
  - [è®¾ç½®æœ¬åœ° DNS](#è®¾ç½®æœ¬åœ°-dns)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [ç¨‹åºå®ç°åŸç†](#ç¨‹åºå®ç°åŸç†)
- [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ç³»ç»Ÿæ¶æ„è®¾è®¡)
- [æ¨¡å—è¯´æ˜](#æ¨¡å—è¯´æ˜)
- [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
- [æ€§èƒ½ä¼˜åŒ–è¯´æ˜](#æ€§èƒ½ä¼˜åŒ–è¯´æ˜)
- [å®‰å…¨ä¸éšç§](#å®‰å…¨ä¸éšç§)
- [å¦‚ä½•éªŒè¯æ˜¯å¦çœŸçš„èµ° VPN](#å¦‚ä½•éªŒè¯æ˜¯å¦çœŸçš„èµ°-vpn)
- [å¼€å‘è€…æŒ‡å—](#å¼€å‘è€…æŒ‡å—)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ—¨åœ¨ä¸º OpenVPN ç”¨æˆ·æä¾›ä¸€ä¸ªé«˜æ€§èƒ½ã€çµæ´»çš„è§„åˆ™åˆ†æµå·¥å…·ï¼Œé¿å…å…¨éƒ¨æµé‡èµ° VPNï¼Œæ”¯æŒä¸­è‹±è§„åˆ™è®¢é˜…ã€ç¼“å­˜ã€CNAME è§£æã€é˜² DNS æ±¡æŸ“ç­‰ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

- âœ… æœ¬åœ° DNS ä»£ç†ï¼ˆæ”¯æŒ DoH / TCP / UDPï¼‰
- âœ… è‡ªå®šä¹‰è§„åˆ™ä¸è§„åˆ™è®¢é˜…ï¼ˆè‡ªåŠ¨å»é‡åˆå¹¶ï¼‰
- âœ… ç²¾å‡†åˆ†æµï¼ˆæ·»åŠ é™æ€è·¯ç”±èµ° utunXï¼‰
- âœ… è‡ªåŠ¨è¯†åˆ« VPN æ¥å£ï¼ˆå¦‚ utun0 / utun8ï¼‰
- âœ… ä¿®å¤ macOS é»˜è®¤è·¯ç”±ä¸ºç›´è¿ç½‘å¡
- âœ… æ”¯æŒ CNAME å¤šçº§è·³è½¬è§£æ
- âœ… å‘½ä¸­ç¼“å­˜å³è¿”å›ï¼Œè¶…å¿«å“åº”
- âœ… ä¸€é”®å¯åŠ¨ï¼Œæ— éœ€ç¹çé…ç½®

---

## ä½¿ç”¨æ•™ç¨‹

### å‰ç½®ä¾èµ–

- Go 1.18+
- macOS ç³»ç»Ÿï¼ˆæ”¯æŒ `route`ã€`scutil` ç­‰å‘½ä»¤ï¼‰
- å·²è¿æ¥çš„ OpenVPN å®¢æˆ·ç«¯ï¼ˆå¦‚ Tunnelblickï¼‰

### å®‰è£…æ„å»º

```bash
git clone https://github.com/iaaaannn0/openvpnadvanced.git
cd openvpnadvanced
go build -o openvpnadvanced ./cmd
```

### å¯åŠ¨æœåŠ¡

```bash
sudo ./openvpnadvanced
```

### è®¾ç½®æœ¬åœ° DNS

```bash
sudo networksetup -setdnsservers Wi-Fi 127.0.0.1
```

### æµ‹è¯•æ•ˆæœ

```bash
dig youtube.com +short
go run tools/trace.go youtube.com
```

---

## é…ç½®è¯´æ˜

- `assets/rule.list`: è‡ªå®šä¹‰åˆ†æµè§„åˆ™
- `assets/subscriptions.txt`: åœ¨çº¿è§„åˆ™è®¢é˜…æº
- `assets/merged_rule.list`: åˆå¹¶åçš„è§„åˆ™ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `output/vpn_ips.txt`: æ‰€æœ‰è¢«åˆ†æµçš„ IPï¼ˆæ—¥å¿—è¾“å‡ºï¼‰
- `assets/cache.json`: DNS ç¼“å­˜è®°å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

è§„åˆ™æ ¼å¼æ”¯æŒï¼š
```text
DOMAIN-SUFFIX,google.com
DOMAIN,facebook.com
```

---

## ç¨‹åºå®ç°åŸç†

æœ¬ç¨‹åºé€šè¿‡æœ¬åœ° DNS ä»£ç†æœåŠ¡å®ç°ç²¾ç»†åŒ–åŸŸååˆ†æµï¼Œå…¶å·¥ä½œåŸç†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

### 1. ç³»ç»Ÿ DNS é‡å®šå‘

ç”¨æˆ·å°†ç³»ç»Ÿçš„ DNS è®¾ç½®ä¸º `127.0.0.1`ï¼Œç”±æœ¬ç¨‹åºç›‘å¬æœ¬åœ° 53 ç«¯å£ï¼ˆTCP/UDPï¼‰ï¼Œæ‹¦æˆªæ‰€æœ‰ DNS è¯·æ±‚ã€‚

### 2. è§„åˆ™åŒ¹é…ä¸ç¼“å­˜æŸ¥è¯¢

æ”¶åˆ° DNS è¯·æ±‚åï¼Œç¨‹åºä¼šï¼š
- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œå¦‚å·²å­˜åœ¨è§£æç»“æœåˆ™ç›´æ¥è¿”å›
- å¦åˆ™è¿›å…¥è§„åˆ™åˆ¤æ–­æµç¨‹ï¼Œæ ¹æ®åŸŸååŒ¹é… `merged_rule.list` ä¸­çš„è§„åˆ™ï¼ˆæ”¯æŒ `DOMAIN-SUFFIX`ã€`DOMAIN` ç­‰ï¼‰

### 3. DoH è§£æä¸ CNAME è·Ÿè¸ª

è‹¥å‘½ä¸­è§„åˆ™æˆ–ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™ä½¿ç”¨ Cloudflare / Google DoH æœåŠ¡è¿›è¡Œè§£æï¼š
- é€’å½’æ”¯æŒ Aã€AAAAã€CNAME è·³è½¬é“¾ï¼Œç›´åˆ°è·å¾—çœŸå® IP åœ°å€
- å¯¹æ¯ä¸€ä¸ªè·³è½¬ä¸­é—´èŠ‚ç‚¹éƒ½å°è¯• A/AAAA fallbackï¼Œç¡®ä¿æ‹¿åˆ°æœ€ç»ˆ IP

### 4. è·¯ç”±æ§åˆ¶

æ ¹æ®æ˜¯å¦å‘½ä¸­è§„åˆ™ï¼š
- âœ… å‘½ä¸­ï¼šè°ƒç”¨ `route add` æŒ‡ä»¤ï¼Œå°†ç›®æ ‡ IP åŠ å…¥è·¯ç”±è¡¨ï¼Œå¹¶æŒ‡å®šèµ° utun æ¥å£ï¼ˆå¦‚ utun8ï¼‰
- âŒ æœªå‘½ä¸­ï¼šä¸ä¿®æ”¹ç³»ç»Ÿè·¯ç”±ï¼Œé»˜è®¤èµ°ç›´è¿å‡ºå£ï¼ˆå¦‚ en0ï¼‰

åŒæ—¶ï¼Œä¸ºé¿å… OpenVPN æ•è·å…¨å±€æµé‡ï¼Œç¨‹åºåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…é™¤ `0.0.0.0/1` å’Œ `128.0.0.0/1` ç­‰ catch-all è·¯ç”±ï¼Œå¹¶é‡å»ºçœŸå®é»˜è®¤ç½‘å…³ã€‚

### 5. è°ƒè¯•å·¥å…· trace.go

æä¾› `tools/trace.go` å·¥å…·ï¼Œå¯æ¨¡æ‹ŸåŸŸåè§£ææµç¨‹ï¼Œè¾“å‡ºï¼š
- å‘½ä¸­è§„åˆ™çŠ¶æ€
- å½“å‰ IP
- æ˜¯å¦é€šè¿‡ VPN æ¥å£è·¯ç”±
- CNAME è·³è½¬é“¾

---

## ç³»ç»Ÿæ¶æ„è®¾è®¡

```mermaid
graph TD
    A[ç³»ç»Ÿ DNS è¯·æ±‚] --> B[æœ¬åœ° DNS ä»£ç† :53]
    B --> C[è§„åˆ™åŒ¹é…å¼•æ“]
    C -->|å‘½ä¸­| D[æ·»åŠ é™æ€è·¯ç”± -> utunX]
    C -->|æœªå‘½ä¸­| E[èµ°é»˜è®¤å‡ºå£ en0]
    B --> F[DNS over HTTPS è§£æ]
    F --> G[é€’å½’è§£æ + CNAME æ”¯æŒ]
    G --> H[ç¼“å­˜æ¨¡å—]
    H --> B
```

---

## æ¨¡å—è¯´æ˜

| æ¨¡å— | è·¯å¾„ | åŠŸèƒ½è¯´æ˜ |
|------|------|----------|
| main.go | `cmd/` | ç¨‹åºä¸»å…¥å£ |
| config.go | `config/` | é…ç½®åŠ è½½ |
| doh.go | `doh/` | DoH è§£æå®ç° |
| server.go | `dnsproxy/` | DNS ä»£ç†ç›‘å¬ |
| fetcher.go / parser.go | `fetcher/` | è®¢é˜…æ‹‰å–ä¸è§„åˆ™è§£æ |
| openvpn.go | `vpn/` | VPN æ¥å£è¯†åˆ«ã€è·¯ç”±è®¾ç½® |
| trace.go | `tools/` | è°ƒè¯•ç”¨ trace å·¥å…· |

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: å¯åŠ¨æ—¶æç¤º "No VPN interface found"
- è¯·ç¡®ä¿ä½ å·²è¿æ¥ VPNï¼Œä½¿ç”¨ `ifconfig` æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ utun æ¥å£

### Q2: `route: not in table` æŠ¥é”™
- è¯´æ˜é»˜è®¤è·¯ç”±å·²è¢«ç§»é™¤ï¼Œæ— éœ€å¤„ç†

### Q3: æŸäº›åŸŸåæ— æ³•è®¿é—®ï¼ˆå¦‚ `ted.com`ï¼‰
- å¯èƒ½æ˜¯ CNAME è§£ææœªé€’å½’åˆ°åº•ï¼Œç¨‹åºå·²æ”¯æŒé€’å½’å¤„ç†ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆ

### Q4: å¦‚ä½•è¿˜åŸ DNS è®¾ç½®ï¼Ÿ

```bash
sudo networksetup -setdnsservers Wi-Fi empty
```

---

## æ€§èƒ½ä¼˜åŒ–è¯´æ˜

ä¸ºäº†ç¡®ä¿é«˜æ•ˆç¨³å®šè¿è¡Œï¼Œæœ¬ç¨‹åºè¿›è¡Œäº†ä»¥ä¸‹ä¼˜åŒ–è®¾è®¡ï¼š

- **DNS ç¼“å­˜æœºåˆ¶**ï¼šæ‰€æœ‰è§£æç»“æœå°†ç¼“å­˜è‡³ `assets/cache.json`ï¼Œé¿å…é‡å¤è§£æã€å‡å°‘ DoH è¯·æ±‚ã€‚
- **æŒ‰éœ€æ·»åŠ è·¯ç”±**ï¼šä»…å¯¹å‘½ä¸­è§„åˆ™çš„ç›®æ ‡ IP æ·»åŠ é™æ€è·¯ç”±ï¼Œé¿å…æ±¡æŸ“å…¨å±€è·¯ç”±è¡¨ã€‚
- **é€’å½’è§£æä¼˜åŒ–**ï¼šåœ¨è§£æ CNAME é“¾æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜å‘½ä¸­ï¼Œæœªå‘½ä¸­æ‰é€’å½’è¿›è¡Œ DoH æŸ¥è¯¢ã€‚
- **è®¢é˜…è§„åˆ™å»é‡**ï¼šè‡ªåŠ¨åˆå¹¶ä¸å»é‡æœ¬åœ°å’Œè¿œç¨‹è§„åˆ™ï¼Œæå‡åŒ¹é…æ•ˆç‡ã€‚

---

## å®‰å…¨ä¸éšç§

æˆ‘ä»¬é‡è§†ç”¨æˆ·æ•°æ®çš„ç§å¯†æ€§ï¼š

- æ‰€æœ‰ DNS æŸ¥è¯¢å‡ä½¿ç”¨åŠ å¯†çš„ DNS-over-HTTPSï¼ˆDoHï¼‰åè®®å®Œæˆï¼Œé˜²æ­¢æ˜æ–‡æ³„æ¼ã€‚
- æœ¬åœ°ä»…ç¼“å­˜ IP ç»“æœï¼Œ**ä¸è®°å½•è®¿é—®æ¥æºä¸ç”¨æˆ·ä¿¡æ¯**ã€‚
- ç”¨æˆ·å¯éšæ—¶æ‰‹åŠ¨æ¸…é™¤ `assets/cache.json` æ¥ç§»é™¤ DNS å†å²è®°å½•ã€‚

---

## å¦‚ä½•éªŒè¯æ˜¯å¦çœŸçš„èµ° VPN

ä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨ç¡®è®¤ç›®æ ‡ IP æ˜¯å¦é€šè¿‡ VPN æ¥å£ï¼š

```bash
# ç¤ºä¾‹ï¼šæ£€æŸ¥ youtube.com æ˜¯å¦é€šè¿‡ utun8
dig youtube.com +short
# å‡è®¾è¿”å› 64.233.162.91

route -n get 64.233.162.91
```

å¦‚æœè¾“å‡ºåŒ…å«å¦‚ä¸‹å­—æ®µï¼š

```
interface: utun8
```

åˆ™è¯´æ˜è¯¥åŸŸåçš„è®¿é—®æµé‡å·²æˆåŠŸè¢«è·¯ç”±è‡³ VPN æ¥å£ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨ç¨‹åºè‡ªå¸¦å·¥å…·ï¼š

```bash
go run tools/trace.go youtube.com
```

è¾“å‡ºå°†æ˜¾ç¤ºï¼š

```
Route via: utun8
âœ… This domain is routed through VPN
```

---

## å¼€å‘è€…æŒ‡å—

```bash
# è¿è¡Œä¸»ç¨‹åº
sudo go run cmd/main.go

# è°ƒè¯• DNS è·¯ç”±è¡Œä¸º
go run tools/trace.go example.com
```

### é¡¹ç›®ç»“æ„

```text
.
â”œâ”€â”€ cmd/                 # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ config/              # é…ç½®è¯»å–
â”œâ”€â”€ dnsmasq/             # DNS è§£æå’Œç¼“å­˜
â”œâ”€â”€ doh/                 # DoH é€»è¾‘
â”œâ”€â”€ dnsproxy/            # DNS æœåŠ¡ç›‘å¬
â”œâ”€â”€ fetcher/             # è®¢é˜…å’Œè§„åˆ™æ‹‰å–
â”œâ”€â”€ vpn/                 # VPN ç›¸å…³æ¥å£/è·¯ç”±
â”œâ”€â”€ tools/               # è°ƒè¯•å·¥å…·
â”œâ”€â”€ assets/              # é…ç½®æ–‡ä»¶å’Œç¼“å­˜
â””â”€â”€ output/              # è·¯ç”±è®°å½•è¾“å‡º
```

---

## å…³é”®å‡½æ•°è¯´æ˜

ä»¥ä¸‹ä¸ºé¡¹ç›®ä¸­å„æ ¸å¿ƒæ¨¡å—çš„å…³é”®å‡½æ•°ç®€è¦è¯´æ˜ï¼š

#### dnsmasq/

- `ResolveRecursive(domain string, rules []Rule, cache *Cache)`: é€’å½’è§£æåŸŸåï¼ˆå« CNAME æ”¯æŒï¼‰ï¼Œè¿”å›æ˜¯å¦å‘½ä¸­è§„åˆ™åŠ IPã€‚
- `ResolveWithCNAME(domain string, rules []Rule, cache *Cache)`: ä¸ä¸Šç±»ä¼¼ï¼Œä½†é¢å¤–è¿”å›é¦–ä¸ª CNAME è·³è½¬åï¼Œç”¨äº trace è§†å›¾ã€‚
- `MatchesRules(domain string, rules []Rule)`: åˆ¤æ–­åŸŸåæ˜¯å¦åŒ¹é…è§„åˆ™é›†ã€‚

#### doh/

- `Query(domain string)`: æ‰§è¡Œ A è®°å½•æŸ¥è¯¢ã€‚
- `QueryAAAA(domain string)`: æ‰§è¡Œ AAAA è®°å½•æŸ¥è¯¢ï¼ˆIPv6ï¼‰ã€‚
- `QueryWithCNAME(domain string)`: è¿”å› A + CNAMEï¼ˆè‹¥å­˜åœ¨ï¼‰ä¿¡æ¯ã€‚
- `QueryAll(domain string)`: è¿”å›æ‰€æœ‰è®°å½•ï¼ˆAã€AAAAã€CNAMEï¼‰ã€‚

#### dnsproxy/

- `StartDNSProxy(...)`: å¯åŠ¨æœ¬åœ° DNS æœåŠ¡ï¼Œç›‘å¬ TCP/UDP :53 ç«¯å£ï¼Œå†…éƒ¨è°ƒç”¨ä¸Šå±‚è§£æé€»è¾‘ã€‚

#### vpn/

- `DetectVPNInterface()`: è‡ªåŠ¨è¯†åˆ«å½“å‰ç³»ç»Ÿçš„ utun æ¥å£åç§°ã€‚
- `AddRoute(ip, iface string)`: å°†æŒ‡å®š IP æ·»åŠ è·¯ç”±è¡¨ä¸­å¹¶æŒ‡å‘æŒ‡å®š VPN æ¥å£ã€‚
- `CorrectDefaultRoute()`: ä¿®å¤é»˜è®¤ç½‘å…³ä¸ºç›´è¿ç½‘å¡ï¼Œå¹¶ç§»é™¤ VPN catch-all è·¯ç”±ã€‚

#### fetcher/

- `LoadRulesFromFile(path string)`: åŠ è½½æœ¬åœ°è§„åˆ™åˆ—è¡¨ã€‚
- `LoadSubscriptions()`: ä»è®¢é˜…åœ°å€ä¸‹è½½è¿œç¨‹è§„åˆ™ã€‚
- `MergeRules(...)`: å»é‡åˆå¹¶è§„åˆ™ï¼Œå†™å…¥ merged_rule.listã€‚

#### tools/trace.go

- `main()`: å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºè°ƒè¯• DNS åˆ†æµæ•ˆæœã€‚
- å†…éƒ¨è°ƒç”¨ `ResolveWithCNAME()` å¹¶æ‰“å°æ˜¯å¦å‘½ä¸­è§„åˆ™ã€è·¯ç”±å‡ºå£ç­‰è°ƒè¯•ä¿¡æ¯ã€‚

> æ‰€æœ‰å‡½æ•°éƒ½æœ‰è¯¦ç»†æ³¨é‡Šï¼Œæ”¯æŒåœ¨ IDE ä¸­è·³è½¬æŸ¥é˜…å…·ä½“å®ç°ã€‚

---

## è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨ [MIT License](https://opensource.org/licenses/MIT) å¼€æºè®¸å¯åè®®ã€‚

```
MIT License

Copyright (c) 2025

Permission is hereby granted, free of charge, to any person obtaining a copy...
```

---

æ¬¢è¿ Starâ­ã€æ Issueã€æ PRï¼Œä¸€èµ·å®Œå–„è¿™ä¸ªå¼ºå¤§å®ç”¨çš„ VPN åˆ†æµå·¥å…·ï¼
